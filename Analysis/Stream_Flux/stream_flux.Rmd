---
title: "Stream Flux"
author: "Andrew"
date: "10/29/2019"
output:
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
library(lubridate)
```

# Data

## Kriddie was here! again!

## Import data
In this document we are going to calculate Evasion from the Vaisala Sensors and compare them to the eosFD flux measurements as well as see how they relate to other variables such as precipitation and temperature. First we import the data and for now we will filter so we are looking at non-injections
```{r data, echo=FALSE, message=FALSE}
df <- read.csv(here("data_4_analysis/All_Stream_Data.csv"))%>%
  select(DateTime,Inj,V1,V2,V3,V4,DO1_mg.L,DO2_mg.L,DO4_mg.L,Flux_1,Flux_2,tempC_436,airTemp_c,ppt24Tot,ppt48Tot,ppt72Tot,stn1_Q,stn2_Q,stn3_Q,stn4_Q)%>%
  filter(Inj == "No")
df$DateTime <- as.POSIXct(df$DateTime)

pptDaily <- read.csv(here("data_4_analysis/ppt.csv"))
pptDaily$DateTime <- as.POSIXct(pptDaily$DateTime)
```

## Create new time variables for ease of plotting
These new variables will help us plot each seperate day on a timescale of midnight -> midnight
```{r}
df$day <- as.factor(substr(as.character(df$DateTime),1,10))
times <- substr(as.character(df$DateTime),12,16)
df$time <- strftime(df$DateTime, format="%H:%M")
df$time <- as.POSIXct(df$time, format="%H:%M")

todayStart <- as.POSIXct(paste0(Sys.Date(),"00:00:00"))
todayEnd <- as.POSIXct(paste0(Sys.Date(),"23:59:59"))
```


```{r fontSettings, echo=FALSE}
# Axis font
xaxisFont <- list(
  family = "Arial, sans-serif",
  size = 22,
  color = "black"
)

yaxisFont <- list(
  family = "Arial, sans-serif",
  size = 22,
  color = "black"
)

labelFont <- list(
  family = "Arial, sans-serif",
  size = 28,
  color = "black"
)
```


```{r dischargeClassify, echo=FALSE}
df <- df%>%
  arrange(stn3_Q)%>%
  mutate(Discharge = ifelse( stn3_Q <20, "< 20",
                                   ifelse(stn3_Q > 20 & stn3_Q <45, "< 45",
                                          ifelse(stn3_Q > 45 & stn3_Q <90, "< 90",
                                                 ifelse(stn3_Q > 90 & stn3_Q < Inf, "< 250", NA)))))
```


```{r dataSep, echo=FALSE, message=FALSE, warning=FALSE}
filt13 <- df%>%
  filter(!is.na(V1)&!is.na(V3))%>%
  filter(DateTime > as.POSIXct("2019-07-13 00:00:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 19:00:00")|DateTime > as.POSIXct("2019-08-14 23:59"))%>%
  filter(DateTime < as.POSIXct("2019-07-14 00:00")|DateTime > as.POSIXct("2019-07-14 23:59"))%>%
  filter(!DateTime == as.POSIXct("2019-08-09 09:57:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 11:15:00") | DateTime > as.POSIXct("2019-08-13 12:00:00"))

filt34 <- df%>%
  filter(!is.na(V1)&!is.na(V4))%>%
  filter(DateTime > as.POSIXct("2019-07-13 00:00:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 19:00:00")|DateTime > as.POSIXct("2019-08-14 23:59"))%>%
  filter(DateTime < as.POSIXct("2019-07-14 00:00")|DateTime > as.POSIXct("2019-07-14 23:59"))%>%
  filter(!DateTime == as.POSIXct("2019-08-09 09:57:00"))
```


# CO2 Change

## Change in CO2
  The first step in calculating flux from the stream is to calculate change in CO2 concentrations between two points within the stream. We will look at two pairs of sensors (1->3 & 3->4). Once we determine change in CO2 concentration, we will convert ppm to uMols and then account for stream metabolism (respiration and photosynthesis) to calculate flux. First, let's visualize change in CO2 accross the pairs of sensors

 
```{r filt14PpmPlot, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9}

legendtitle <- list(yref='paper',xref="paper",y=.8,x=1.35, text="Discharge<br> [L/s<sup>-1</sup>]",showarrow=F)

plotly13Ppm <- filt13%>%
  arrange(stn3_Q)%>%
  plot_ly(x = ~time, y = ~V3-V1)%>%
  add_markers(color = ~factor(Discharge, c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"), legendgroup = ~Discharge, showlegend = F)%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
    showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "DCO2 Change (Station 3-1 / Station 4-3)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -2500, y1 = 100, yref = "y")),
  yaxis = list(title = "&#916;CO<sub>2</sub> [ppm]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=T)


plotly34Ppm <- filt34%>%
  arrange(stn3_Q)%>%
  plot_ly(x = ~time, y = ~V4-V3, sort = FALSE)%>%
  add_markers(color = ~factor(Discharge, levels = c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"),legendgroup = ~Discharge)%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "DCO2 Change (Station 3-1 / Station 4-3)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -2500, y1 = 100, yref = "y")),
  yaxis = list(title = "&Delta;CO<sub>2</sub> [ppm]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend = T,
  annotations = legendtitle,
  legend = list(x = 1, y = .5))%>%
  hide_colorbar()


subplot(plotly13Ppm,plotly34Ppm, shareY = T)
```

So now that we know what the change in CO2 between stations, it's time to account for stream metabolism. Stream metabolism includes Ecosystem Respiration (ER) and Gross Primary Production / phtosynthesis (GPP). Both of these processes include a 1:1 exchange of CO2 and DO molecules. 
**Photosynthesis:** Use CO2 and create O2 (1:1 ratio). 

**Respiration:** Use O2, create CO2 (1:1 ratio).

Respiration can occur in the abscence of sunlight while photosynthesis cannot. At night, stream processes are respiration driven. During the day both respiration and photosynthesis occur. We can look at the changes in DO over the similar stretches of stream and time period. We did not have a DO sensor at station 3 but we did have one at station 2.

# Dissolved Oxygen

## Change in Dissolved Oxygen
```{r DOchange, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9}
legendtitle <- list(yref='paper',xref="paper",y=.8,x=1.35, text="Discharge<br> [L/s<sup>-1</sup>]",showarrow=F)

plotly13DOPpm <- filt13%>%
  plot_ly(x = ~time, y = ~DO2_mg.L-DO1_mg.L)%>%
  add_markers(color = ~factor(Discharge, c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"), legendgroup = ~Discharge, showlegend = F)%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
    showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "DO Change (Station 2-1 / Station 4-2)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -1.5, y1 = 4.5, yref = "y")),
  yaxis = list(title = "&#916;DO [mg/L]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=T)


plotly34DOPpm <- filt34%>%
  arrange(stn3_Q)%>%
  plot_ly(x = ~time, y = ~DO4_mg.L-DO2_mg.L, sort = FALSE)%>%
  add_markers(color = ~factor(Discharge, levels = c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"),legendgroup = ~Discharge)%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "DO Change (Station 2-1 / Station 4-2)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -1.5, y1 = 4.5, yref = "y")),
  yaxis = list(title = "&Delta;DO [mg/L]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend = T,
  annotations = legendtitle,
  legend = list(x = 1, y = .5))%>%
  hide_colorbar()


subplot(plotly13DOPpm,plotly34DOPpm, shareY = T)
```

# Mass Conversion

## Convert CO2 from concentration to mass
Now that we know the change in CO2 in terms of concentration (ppm), we can convert it to mass. Specifically, we will take this opportunity to convert to micromoles (uMols), which we will eventually use to express evasion.
```{r CO2ppm2uMols}
# Distances are 17,30,80

filt13$uMols_13 <- ((filt13$V1-filt13$V3)/ 37.6) *.0018*(1000000/44.01)*filt13$stn1_Q/1000 

filt34$uMols_34 <- ((filt34$V3-filt34$V4)/ 64) *.0018*(1000000/44.01)*filt34$stn3_Q/1000
```

# Plotting data

## Histograms of change in CO2
```{r CO2Hist, echo=FALSE, warning = FALSE, message=FALSE, fig.width=10}
hist13 <- ggplot(filt13)+
  geom_histogram(aes(x = uMols_13),fill = "#767676",color="#4B9CD3",binwidth = 1)+
  geom_vline(xintercept = 0, linetype="dotted", color = "#4B9CD3", size=1.5)+
  xlim(-10,40)+
  ylim(0,2200)+
  labs(x = "&mu;mols", y="Count of values",title = "Station 1 -> 3")+
  theme_bw()

hist34 <- ggplot(filt34)+
  geom_histogram(aes(x = uMols_34),fill = "#767676",color="#4B9CD3",binwidth = 1)+
  geom_vline(xintercept = 0, linetype="dotted", color = "#4B9CD3", size=1.5)+
  xlim(-10,40)+
  ylim(0,2200)+
  labs(x = "&mu;mols", y="Count of values",title = "Instantaneous CO2 Loss (Station 1->3 / Station 3 -> 4")+
  theme_bw()

subplot(hist13,hist34, shareY = TRUE, titleX = TRUE)
```



## CO2 Change over time

May or may not use this plot, if so, needs to be cleaned up.
```{r CO2ChangeTime, echo=FALSE, warning=FALSE, fig.width= 10}
solarNoon <- as.POSIXct("12:19", format = "%H:%M")

filt13$noonDif <- as.integer(filt13$time - solarNoon)
filt34$noonDif <- as.integer(filt34$time - solarNoon)

cChange13 <- ggplot(filt13)+
  geom_point(aes(x=DateTime, y= uMols_13, col = noonDif), size = .5)+
  scale_color_gradient2(low = "black",mid = "#f2db79", high = "red",name = "Time")+
  theme_bw()+
  ylim(-10,60)

cChange34 <- ggplot(filt34)+
  geom_point(aes(x=DateTime, y= uMols_34, col = noonDif), size = .5)+
  scale_color_gradient2(low = "black",mid = "#f2db79", high = "red",name = "Time")+
  theme_bw()+
  ylim(-10,60)

subplot(cChange13,cChange34, shareY = TRUE)

```


## Change in CO2 (umols)
```{r CO2Change, echo = FALSE, message=FALSE, warning = FALSE, fig.width=10}

## Plotly
legendtitle <- list(yref='paper',xref="paper",y=.78,x=1.3, text="Discharge<br> [L s<sup>-1</sup>]",showarrow=F)

CO2uMols13 <- filt13%>%
  plot_ly(x = ~time, y = ~uMols_13)%>%
  add_markers(color = ~factor(Discharge, c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"), legendgroup = ~Discharge, showlegend = F)%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
    showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "&#916;CO<sub>2</sub> (Station 3-1 / Station 4-3) [&mu;mol m<sup>-2</sup>s<sup>-1</sup>]",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -10, y1 = 65, yref = "y")),
  yaxis = list(title = "&#916;CO<sub>2</sub> [&mu;mol m<sup>-2</sup>s<sup>-1</sup>]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=T)


CO2uMols34 <- filt34%>%
  arrange(stn3_Q)%>%
  plot_ly(x = ~time, y = ~uMols_34, sort = FALSE)%>%
  add_markers(color = ~factor(Discharge, levels = c('< 20', '< 45', '< 90', '< 250')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"),legendgroup = ~Discharge)%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(todayStart)*1000,
             as.numeric(todayEnd)*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "&#916;CO<sub>2</sub> (Station 3-1 / Station 4-3) [&mu;mol m<sup>-2</sup>s<sup>-1</sup>]",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = paste0(Sys.Date(), " 06:15"), x1 = paste0(Sys.Date(), " 18:21"), xref = "x",
                    y0 = -10, y1 = 65, yref = "y")),
  yaxis = list(title = "&Delta;CO<sub>2</sub> [&mu;mols] m<sup>-2</sup>s<sup>-1</sup>]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend = T,
  annotations = legendtitle,
  margin = list(t = 40),
  legend = list(x = 1, y = .5))%>%
  hide_colorbar()


subplot(CO2uMols13,CO2uMols34, shareY = T)
  
```

# Evasion Using Daily Stream Metabolism
Using the USGS [streammetabolizer](http://usgs-r.github.io/streamMetabolizer/) package, daily estimates of GPP and ER can be calculated at each of the DO sensor locations. This is done in a seperate script located in: 'Ecuador/Analysis/Stream_Metabolism/metabolism.R'. The results are used to estimate daily evasion for the reach. The values expressed in the results of the streammetabolizer tool are grams of O2 / m^2 /d^-1. We need to convert this into uMols and then multiply by -1 to determine uMols CO2. 
```{r evasionMetabolism, echo=FALSE, warning=FALSE, message=FALSE}
pred1 <- read.csv(here("Analysis/Stream_Metabolism/ModelOutputs/DO_1_Predictions.csv"))%>%
  select(date,GPP,ER)%>%
  mutate(Station = "1")
pred2 <- read.csv(here("Analysis/Stream_Metabolism/ModelOutputs/DO_2_Predictions.csv"))%>%
  select(date,GPP,ER)%>%
  mutate(Station = "2")
pred4 <- read.csv(here("Analysis/Stream_Metabolism/ModelOutputs/DO_4_Predictions.csv"))%>%
  select(date,GPP,ER)%>%
  mutate(Station = "4")

metab <- rbind(pred1,pred2,pred4)%>%
  mutate(DateTime = as.POSIXct(date))


# Legend Title
legendtitle <- list(yref='paper',xref="paper",y=.8,x=1.08, text="<b>Station</b>",showarrow=F)

gpp <- metab%>%
  plot_ly(x = ~DateTime, y = ~GPP,hoverinfo = "text",
        text = ~paste("Station: ", Station,
        "<br> Date: ", DateTime,
        "<br> ER: ", round(ER,2)))%>%
  add_markers(color = ~Station, size=50)%>%
  layout(
    title = "Gross Primary Productivity (DO)",
    xaxis = list(title = "Date", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  type = "date",
  tickformat = "%b %d"),
    yaxis = list(title = "GPP [g/m<sup>2</sup>d<sup>-1</sup>]", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
    legend = list (x = 1, y=.5),
    annotations = legendtitle
  )

resp <- metab%>%
  plot_ly(x = ~DateTime, y = ~ER,hoverinfo = "text",
        text = ~paste("Station: ", Station,
        "<br> Date: ", DateTime,
        "<br> GPP: ", round(GPP,2)))%>%
  add_markers(color = ~Station, size = 50)%>%
  layout(
    title = "Ecosystem Respiration (DO)",
    xaxis = list(title = "Date", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  type = "date",
  tickformat = "%b %d"),
    yaxis = list(title = "GPP [g/m<sup>2</sup>d<sup>-1</sup>]", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
    legend = list (x = 1, y=.5),
    annotations = legendtitle
  )

subplot(gpp,resp,shareX = TRUE)
```

## Estimate daily ER and GPP in uMols of CO2
1 mole of CO2 = 31.9988 grams.
```{r metabConvert, echo=FALSE, warning=FALSE, message=FALSE}
metabCO2 <- metab%>%
  mutate(GPP_CO2uMol = GPP/31.9988*-1000000,
         ER_CO2uMol = ER/31.9988*-1000000)

# Legend Title
legendtitle <- list(yref='paper',xref="paper",y=.8,x=1.08, text="<b>Station</b>",showarrow=F)

gppCO2 <- metabCO2%>%
  plot_ly(x = ~DateTime, y = ~GPP_CO2uMol,hoverinfo = "text",
        text = ~paste("Station: ", Station,
        "<br> Date: ", DateTime,
        "<br> ER: ", round(ER_CO2uMol,2)))%>%
  add_markers(color = ~Station, levels = c('1', '2', '3'), colors = c("#E2D200","#46ACC8","#B40F20"),size = 50)%>%
  layout(
    title = "Gross Primary Productivity (CO<sub>2</sub>)",
    xaxis = list(title = "Date", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  type = "date",
  tickformat = "%b %d"),
    yaxis = list(title = "CO<sub>2</sub> [&mu;mol/m<sup>2</sup>d<sup>-1</sup>]", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
    legend = list (x = 1, y=.5),
    annotations = legendtitle
  )


respCO2 <- metabCO2%>%
  plot_ly(x = ~DateTime, y = ~ER_CO2uMol,hoverinfo = "text",
        text = ~paste("Station: ", Station,
        "<br> Date: ", DateTime,
        "<br> ER: ", round(GPP_CO2uMol,2)))%>%
  add_markers(color = ~Station, levels = c('1', '2', '3'), colors = c("#E2D200","#46ACC8","#B40F20"), size = 50)%>%
  layout(
    title = "Ecosystem Respiration (CO<sub>2</sub>)",
    xaxis = list(title = "Date", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  type = "date",
  tickformat = "%b %d"),
    yaxis = list(title = "CO<sub>2</sub> [&mu;mol/m<sup>2</sup>d<sup>-1</sup>]", titlefont = labelFont,showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
    legend = list (x = 1, y=.5),
    annotations = legendtitle
  )
```

## Average ER and GPP Values for Stations 1 & 2
We average the GPP and ER values at station 1 & 2 for use with change in CO2 between station 1 and 3. We use GPP and ER estimates from station 4 for the change in CO2 between stations 3 and 4.
```{r, warning=FALSE, message=FALSE}
stn12 <- metabCO2%>%
  filter(Station < 4)%>%
  group_by(DateTime)%>%
  mutate(GPP_CO2uMol12 = mean(GPP_CO2uMol),
         ER_CO2uMol12 = mean(ER_CO2uMol))%>%
  ungroup()

stn4 <- metabCO2%>%
  filter(Station == 4)%>%
  mutate(GPP_CO2uMol34 = GPP_CO2uMol,
         ER_CO2uMol34 = ER_CO2uMol)

metabCO2avg <- left_join(stn12,stn4, by="date")
```

# Evasion Calculations

## Convert CO2 Change into Daily Values
```{r evasionDaily, warning=FALSE, message = FALSE}
DCO2Daily13 <- filt13%>%
  group_by(day)%>%
  mutate(DailyChange13 = mean(uMols_13*86400))%>%
  select(day,DailyChange13)%>%
  distinct()%>%
  rename("date"="day")

DCO2Daily <- filt34%>%
  group_by(day)%>%
  mutate(DailyChange34 = mean(uMols_34*86400))%>%
  select(day,DailyChange34)%>%
  distinct()%>%
  rename("date"="day")%>%
  left_join(DCO2Daily13, by="date")
```


## Merge 'Daily Change' with stream metabolism to get metabolism adjusted evasion
```{r evasionPlots, echo=FALSE, warning=FALSE, message=FALSE}
metabAvg <- metabCO2avg%>%
  select(date,GPP_CO2uMol12,ER_CO2uMol12,GPP_CO2uMol34,ER_CO2uMol34)%>%
  distinct()

adjustEvasion <- metabAvg%>%
  left_join(DCO2Daily,by="date")%>%
  mutate(AdjEvasion12 = DailyChange13+GPP_CO2uMol12+ER_CO2uMol12,
         AdjEvasion34 = DailyChange34+GPP_CO2uMol34+ER_CO2uMol34,
         date = as.POSIXct(date))

#color = wes_palette("Zissou1")[c(1,3,5)]    #WesAnderson
color = c("#4B9CD3","#16b55b","#f57f11")


up <- adjustEvasion%>%
  select(date,AdjEvasion12,ER_CO2uMol12,GPP_CO2uMol12)%>%
  rename("Evasion" = "AdjEvasion12", "Respiration"="ER_CO2uMol12", "Photosynthesis" = "GPP_CO2uMol12")%>%
  gather(Var,Val,-date)

up$Var <- as.factor(up$Var)

var <- levels(up$Var)
```






## Daily Evasion & Metabolism in &#181;mol

```{r evasion_uMolsPerDay, echo=FALSE,warning=FALSE,message=FALSE, fig.width=10}

legendtitle <- list(yref='paper',xref="paper",y=.65,x=1.3, text="<b>Process</b>",showarrow=F)
note <- list(yref='paper',xref="paper",y=.2,x=1.45, text="<i>*Respiration is<br>shown as<br>absolute value.</i>",showarrow=F)

# Upstream Plot
uplot <- up%>%
  plot_ly(x = ~date, y = ~abs(Val))%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var)%>%
  layout(
    title = "Daily Evasion & Metabolism (Upstream)",
    xaxis = list(title = "Date", titlefont = labelFont, type = "date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "&mu;mol/m<sup>2</sup>d<sup>-1</sup>", type = "log",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont,
  range = c(3,7)),
  showlegend=F,
  legend = list(x=1, y=.5)
  )


# Downstream Plot
down <- adjustEvasion%>%
  select(date,AdjEvasion34,ER_CO2uMol34,GPP_CO2uMol34)%>%
  rename("Evasion" = "AdjEvasion34", "Respiration"="ER_CO2uMol34", "Photosynthesis" = "GPP_CO2uMol34")%>%
  gather(Var,Val,-date)

dplot <- down%>%
  plot_ly(x = ~date, y = ~abs(Val))%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var, showlegend = F)%>%
  layout(
    title = "Daily Evasion & Metabolism",
    xaxis = list(title = "Date", titlefont = labelFont, type="date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "", type = "log",titlefont = labelFont,
  showticklabels = FALSE,
  tickangle = 0,
  tickfont = yaxisFont,
  range = c(3,7)),
  annotations = list(legendtitle,note),
  legend = list(x=1, y=.5)
  )

subplot(uplot,dplot, titleY = TRUE, titleX = TRUE, shareY = TRUE)
# Try changing to mols
# Try changing to per second


```

## As &mu;mols m<sup>2</sup>s<sup>-1</sup>

```{r evasionUmolsPerSec, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}

legendtitle <- list(yref='paper',xref="paper",y=.65,x=1.3, text="<b>Process</b>",showarrow=F)
note <- list(yref='paper',xref="paper",y=.2,x=1.45, text="<i>*Respiration is<br>shown as<br>absolute value.</i>",showarrow=F)


uplot <- up%>%
  plot_ly(x = ~date, y = ~abs(Val)/86400)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var)%>%
  layout(
    title = "Daily Evasion & Metabolism (Upstream)",
    xaxis = list(type = "date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "&mu;mol/m<sup>2</sup>s<sup>-1</sup>", type = "log",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=F,
  legend = list(x=1, y=.5)
  )

# Downstream
dplot <- down%>%
  plot_ly(x = ~date, y = ~abs(Val)/86400)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var, showlegend = F)%>%
  layout(
    title = "Daily Evasion & Metabolism",
    xaxis = list(type="date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "", type = "log",titlefont = labelFont,
  showticklabels = FALSE,
  tickangle = 0,
  tickfont = yaxisFont),
  annotations = list(legendtitle,note),
  legend = list(x=1, y=.5)
  )

subplot(uplot,dplot, titleY = TRUE, titleX = TRUE, shareY = TRUE)
```

## As moles m<sup>2</sup>d<sup>-1</sup>
```{r evasionMolsPerDay, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}

legendtitle <- list(yref='paper',xref="paper",y=.65,x=1.3, text="<b>Process</b>",showarrow=F)
note <- list(yref='paper',xref="paper",y=.2,x=1.45, text="<i>*Respiration is<br>shown as<br>absolute value.</i>",showarrow=F)


uplot <- up%>%
  plot_ly(x = ~date, y = ~abs(Val)/1000000)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var)%>%
  layout(
    title = "Daily Evasion & Metabolism (Upstream)",
    xaxis = list(type = "date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "mol/m<sup>2</sup>d<sup>-1</sup>", type = "",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=F,
  legend = list(x=1, y=.5)
  )

# Downstream
dplot <- down%>%
  plot_ly(x = ~date, y = ~abs(Val)/1000000)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var, showlegend = F)%>%
  layout(
    title = "Daily Evasion & Metabolism",
    xaxis = list(type="date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "", type = "",titlefont = labelFont,
  showticklabels = FALSE,
  tickangle = 0,
  tickfont = yaxisFont),
  annotations = list(legendtitle,note),
  legend = list(x=1, y=.5)
  )

subplot(uplot,dplot, titleY = TRUE, titleX = TRUE, shareY = TRUE)
```


## As moles m<sup>2</sup>d<sup>-1</sup>
```{r evasionMolsPerDayLog, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}

legendtitle <- list(yref='paper',xref="paper",y=.65,x=1.3, text="<b>Process</b>",showarrow=F)
note <- list(yref='paper',xref="paper",y=.2,x=1.45, text="<i>*Respiration is<br>shown as<br>absolute value.</i>",showarrow=F)


uplot <- up%>%
  plot_ly(x = ~date, y = ~abs(Val)/1000000)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var)%>%
  layout(
    title = "Daily Evasion & Metabolism (Upstream)",
    xaxis = list(type = "date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "mol m<sup>-2</sup>d<sup>-1</sup>", type = "log",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=F,
  legend = list(x=1, y=.5)
  )

# Downstream
dplot <- down%>%
  plot_ly(x = ~date, y = ~abs(Val)/1000000)%>%
  add_markers(color = ~Var,
              colors = ~setNames(color, var),  size=50, legendgroup = ~Var, showlegend = F)%>%
  layout(
    title = "Daily Evasion & Metabolism",
    xaxis = list(type="date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = "E"),
    yaxis = list(title = "", type = "log",titlefont = labelFont,
  showticklabels = FALSE,
  tickangle = 0,
  tickfont = yaxisFont),
  annotations = list(legendtitle,note),
  legend = list(x=1, y=.5)
  )

subplot(uplot,dplot, titleY = TRUE, titleX = TRUE, shareY = TRUE)
```





## Compare with eoSense chamber

```{r eosPlotly, echo=FALSE, message=FALSE, wanring = FALSE, fig.width=10}

# Filter the eos data and scale to daily values
eos <- df%>%
  filter(Inj == "No")%>%
  select(DateTime,Flux_1,day)%>%
  group_by(day)%>%
  mutate(DailyFlux = mean(Flux_1, na.rm = TRUE)*86400/1000000)%>%
  select(day, DailyFlux)%>%
  distinct()%>%
  ungroup()%>%
  mutate(day = as.POSIXct(day))%>%
  arrange(day)%>%
  mutate(day = ymd(day))

plot <- eos%>%
  plot_ly(x=~day, y=~DailyFlux)%>%
  add_trace(line = list(color = '#4B9CD3', width = 6)) %>%
  add_markers(marker = list(color = 'rgb(0,0,0)',size = 10, line = list(
        color = 'rgb(132,135,140)', width=2)))%>%
  layout(
    title = "Daily Evasion from Flux Chamber",
    xaxis = list(type="date",
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = xaxisFont,
  tickformat = "%b %d",
  exponentformat = ""),
    yaxis = list(title = "mol m<sup>-2</sup>d<sup>-1</sup>", type = "",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend = FALSE
  )

plot
```

## Try integrating to get daily estimates of flux from eos
Here we integrate instead of using the daily average and compare to see if they are different.
```{r integrate}

eosInt <- df%>%
  filter(Inj == "No")%>%
  select(DateTime,Flux_1,day)

complete <- eosInt[complete.cases(eosInt), ]
  
integrate <- complete%>%
  arrange(DateTime)%>%
  mutate(Interval = DateTime - lag(DateTime),
         FluxInt = Flux_1 * Interval*60/1000000)%>%
  group_by(day)%>%
  mutate(DailyFluxInt = sum(FluxInt))%>%
  select(day,DailyFluxInt)%>%
  ungroup()%>%
  distinct()%>%
  mutate(day = ymd(day))


join <- left_join(eos,integrate)
join <- join[complete.cases(join),]
join$Date <- seq(1,nrow(join))

join%>%
  plot_ly()%>%
  add_segments(x=0,y=0,xend=.25,yend=.25)%>%
  add_markers(x = ~DailyFlux, y = ~DailyFluxInt, color = ~Date,
              hoverinfo = "text",
              text = ~paste("Integrated: ", DailyFluxInt, " [mol m<sup>-2</sup>d<sup>-1</sup>]<br>",
                            "Daily Average: ", DailyFlux, " [mol m<sup>-2</sup>d<sup>-1</sup>]<br>",
                            "Date: ", day))%>%
  layout(xaxis = list(title = "Daily Average"),
         yaxis = list(title = "Integrated Daily"))
  


  
```



## X/Y
```{r xyFlux, echo=FALSE, warning=FALSE, message = FALSE, fig.width=10}

# combine flux from Vaisala to eosFD
eosFlux <- eos%>%
  rename("date"="day","eosFlux"="DailyFlux")
fluxCompare <- up%>%
  filter(Var == "Evasion")%>%
  select(date,Val)%>%
  rename("vFlux" = "Val")%>%
  left_join(eosFlux)%>%
  na.omit()%>%
  mutate(vFlux = vFlux/1000000)

# Fit regression line
fit <- lm(vFlux ~ eosFlux, data = fluxCompare)


fPlot <- fluxCompare%>%
  plot_ly(x=~eosFlux,y=~vFlux)%>%
  add_markers(marker = list(color = 'rgb(75,156,211)',size = 10, line = list(
        color = 'rgb(132,135,140)', width=2)),showlegend=FALSE)%>%
  add_lines(x = c(0,.4),y = c(0,.4), name="1:1",line = list(color = 'rgb(0,0,0)'))%>%
  layout(
    title = "Comparison of Evasion Estimation Methods",
    xaxis = list(title="eosFD CO<sub>2</sub> mol m<sup>-2</sup>d<sup>-1</sup>",
  showticklabels = TRUE,
  tickangle = 0,
  dtick = 0.1, 
  tick0 = 0,
  tickfont = xaxisFont,
  titlefont = labelFont,
  exponentformat = "",
  range = c(0,.42)),
    yaxis = list(title = "Vaisala CO<sub>2</sub> mol m<sup>-2</sup>d<sup>-1</sup>",
                 type = "",
                 titlefont = labelFont,
                 dtick = 0.1, 
                 tick0 = 0, 
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont,
  range = c(0,.42)),
  showlegend = TRUE,
  legend = list(x=1,y=.5)
  )

fPlot
```


