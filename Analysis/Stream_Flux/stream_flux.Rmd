---
title: "Stream Flux"
author: "Andrew"
date: "10/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
```

## Import data
In this document we are going to calculate Evasion from the Vaisala Sensors and compare them to the eosFD flux measurements as well as see how they relate to other variables such as precipitation and temperature. First we import the data and for now we will filter so we are looking at non-injections
```{r data, echo=FALSE, message=FALSE}
df <- read.csv(here("data_4_analysis/All_Stream_Data.csv"))%>%
  select(DateTime,Inj,V1,V2,V3,Flux_1,Flux_2,tempC_436_m,airTemp_c,ppt24Tot,ppt48Tot,ppt72Tot,stn1_Q,stn2_Q,stn3_Q,stn4_Q)%>%
  filter(Inj == "No")
df$DateTime <- as.POSIXct(df$DateTime, format = "%m/%d/%Y %H:%M")

pptDaily <- read.csv(here("data_4_analysis/ppt.csv"))
pptDaily$DateTime <- as.POSIXct(pptDaily$DateTime)
```

# Create new time variables for ease of plotting
These new variables will help us plot each seperate day on a timescale of midnight -> midnight
```{r}
df$day <- as.factor(substr(as.character(df$DateTime),1,10))
times <- substr(as.character(df$DateTime),12,16)
df$time <- strftime(df$DateTime, format="%H:%M")
df$time <- as.POSIXct(df$time, format="%H:%M")
```

## Change in CO2 Station 1->4
Let's visualize the changes in diel CO2 concentrations between a pair of sensors. Here we look at the entire reach, so stations 1 -> 4. We have a filter to remove some data that had issues.
```{r filt14PpmPlot}
filt <- df%>%
  filter(!is.na(V1)&!is.na(V4))%>%
  filter(DateTime > as.POSIXct("2019-07-13 00:00:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 19:00:00")|DateTime > as.POSIXct("2019-08-14 23:59"))%>%
  filter(DateTime < as.POSIXct("2019-07-14 00:00")|DateTime > as.POSIXct("2019-07-14 23:59"))%>%
  filter(!DateTime == as.POSIXct("2019-08-09 09:57:00"))


dayPoly <- data.frame(x = c(as.POSIXct("06:15", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("06:15", format = "%H:%M")),y=c(-3200,-3200,-100,-100))

my_breaks <- c(0,15,50,166) # Create breaks

plot14Ppm <- ggplot(filt)+
  geom_polygon(data = dayPoly,aes(x=x,y=y),fill="#f2e198")+
  geom_vline(aes(xintercept = as.POSIXct("06:15", format = "%H:%M")))+
  geom_vline(aes(xintercept = as.POSIXct("18:21", format = "%H:%M")))+
  geom_point(aes(x = time, y = V4-V1,group = day, col=stn1_Q),lwd=2)+
  scale_color_gradient(name = "Discharge (L/s)", trans = "log",
                        breaks = my_breaks, labels = my_breaks)+
  labs(x = "Time",y="DCO2", title = "DCO2 Change station 1 -> 4")+
  theme_bw()

plot14Ppm
```

So now that we know what the change in CO2 between stations, it's time to account for uptake. Uptake can be determined by taking the change in CO2 between stations before sunrise (respiration is zero) and subtracting it from the change in CO2 at all other times.

![Uptake](C:/Users\ARMur\OneDrive - University of North Carolina at Chapel Hill\Ecuador\Github\Ecuador\Images/uptake.png)

## Calculate uptake between stations 1 & 4
Find the max change in pCO2 which will be when respiration is the least (before sunrise). This level serves as the baseline for that day (zero uptake). For every other time, we take the value of V1-V4 and subtract the zero uptake value for that day from it to determine uptake.
```{r uptake14}
filtsub <- filt%>%
  filter(time < as.POSIXct("06:30", format = "%H:%M"))%>%
  group_by(day)%>%
  mutate(baseDeltCo2 = max(V1-V4))%>%
  ungroup()%>%
  select(day,baseDeltCo2)%>%
  distinct()

filt <- left_join(filt,filtsub)%>%
  mutate(Uptake = baseDeltCo2-(V1-V4))

dayPoly <- data.frame(x = c(as.POSIXct("06:15", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("06:15", format = "%H:%M")),y=c(-500,-500,1800,1800))

plotUptake <- ggplot(filt)+
  geom_polygon(data = dayPoly,aes(x=x,y=y),fill="#f2e198")+
  geom_vline(aes(xintercept = as.POSIXct("06:15", format = "%H:%M")))+
  geom_vline(aes(xintercept = as.POSIXct("18:21", format = "%H:%M")))+
  geom_point(aes(x = time, y = Uptake,group = day, col=stn3_Q),lwd=2)+
  scale_color_gradient(name = "Discharge (L/s)", trans = "log",
                        breaks = my_breaks, labels = my_breaks)+
  labs(x = "Time",y="Uptake", title = "CO2 Uptake station 1 -> 4")+
  theme_bw()
plotUptake
```

## Calculate Evasion using my equation
Now that we know the change in CO2 and uptake, we can calculate evasion.
```{r evasionCalc}
# Distances are 17,30,80

filt$evasion_14 <- ((filt$V1-(filt$V4+filt$Uptake))/ 100) *.0018*(1000000/44.01)*filt$stn3_Q/1000

```

## Plot data

### Histogram of Evasion Stations 1 -> 4
```{r}
ggplot(filt, warning = FALSE, message=FALSE)+
  geom_histogram(aes(x = evasion_14),fill = "#767676",color="#4B9CD3",binwidth = 1)+
  geom_vline(xintercept = 0, linetype="dotted", color = "#4B9CD3", size=1.5)+
  xlim(-10,40)+
  ylim(0,2600)+
  labs(x = "Evasion", y="Count of values",title = "Station 1 -> 4")+
  theme_bw()
```



## Evasion and time
```{r evasionTime, echo=FALSE, warning=FALSE}
solarNoon <- as.POSIXct("12:19", format = "%H:%M")

filt$noonDif <- as.integer(filt$time - solarNoon)

evasionTime <- ggplot(filt)+
  geom_line(aes(x=DateTime, y= evasion_14, col = noonDif),lwd=2)+
  scale_color_gradient2(low = "black",mid = "#f2db79", high = "black",name = "Time")+
  theme_bw()

evasionTime
```


### ppt and Evasion
```{r plot}
pptBar <- ggplot()+
  geom_bar(data = pptDaily,stat = "identity", aes(x = DateTime, y = ppt_mm))+
  geom_point(data = filt,aes(x = DateTime, y = evasion_14))


pptBar
```



##Evasion
```{r}
dayPoly <- data.frame(x = c(as.POSIXct("06:15", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("06:15", format = "%H:%M")),y=c(-35,-35,40,40))

plot14 <- ggplot(filt)+
  geom_polygon(data = dayPoly,aes(x=x,y=y),fill="#f2e198")+
  geom_vline(aes(xintercept = as.POSIXct("06:15", format = "%H:%M")))+
  geom_vline(aes(xintercept = as.POSIXct("18:21", format = "%H:%M")))+
  geom_line(aes(x = time, y = evasion_14,group = day, col=stn1_Q),lwd=2)+
  scale_color_gradient(name = "Discharge (L/s)", trans = "log",
                        breaks = my_breaks, labels = my_breaks)+
  labs(x = "Time",y="Evasion", title = "Evasion station 1 -> 4")+
  theme_bw()

plot14
```



## Evasion vs. Evasion
```{r}
ggplot(filt)+
  geom_point(shape=21,aes(x = evasion_14, y=Flux_1, fill = "eosFD 1"), fill="#4B9CD3", alpha =.6,size=2)+
  geom_point(shape=21,aes(x = evasion_14, y=Flux_2, fill = "eosFD 2"), fill="#C7DA7D", alpha = .6,size=2)+
  geom_smooth(aes(x=evasion_14,y=Flux_1),method='lm',formula=y~x, color = "#4B9CD3")+
  geom_smooth(aes(x=evasion_14,y=Flux_2),method='lm',formula=y~x,color ="#C7DA7D")+
  xlim(0,36)+
  ylim(0,6)
```

