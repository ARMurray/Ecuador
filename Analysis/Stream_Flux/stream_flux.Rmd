---
title: "Stream Flux"
author: "Andrew"
date: "10/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(ggplot2)
library(plotly)
```

## Flux plots
In this document we are going to calculate flux from the Vaisala Sensors and compare them to the eosFD flux measurements as well as see how they relate to other variables such as precipitation and temperature.
```{r data, echo=FALSE, message=FALSE}
df <- read.csv(here("data_4_analysis/All_Stream_Data.csv"))%>%
  select(DateTime,Inj,V1,V2,V3,V4,Flux_1,Flux_2,tempC_436_m,airTemp_c,ppt24Tot,ppt48Tot,ppt72Tot,stn1_Q,stn2_Q,stn3_Q,stn4_Q)
df$DateTime <- as.POSIXct(df$DateTime, format = "%m/%d/%Y %H:%M")
```

## Calculate ppt as a running total of the previous X hours
We have precipitation data at five minute intervals for the entire period of data collection thanks to a weather station close to our study site. Data was obtained from the [FONAG hydrometeorolical monitoring netowrk](http://sedc.fonag.org.ec/reportes/consultas/) (Station M5024). I run an iterator to total precipitation for the previous rows. Data collection began on July 9, 2019.
For now I'll create three variables: 24-hour / 48-hour / 72-hour rainfall. This code exists in [Merge_All_Data.R](github.com)

## Plot new ppt variables
```{r pptPlot, echo=FALSE}
ggplot(df)+
  geom_point(aes(x=DateTime, y = ppt24Tot, col = "24 Hour"), col="blue")+
  geom_point(aes(x=DateTime, y = ppt48Tot, col = "48 Hour"), col="red")+
  geom_point(aes(x=DateTime, y = ppt72Tot, col = "72 Hour"), col="green")

```

## Calculate Flux using my equation
```{r fluxCalc}
# Distances are 17,30,80
df$flux_12 <- ((df$V1-df$V2)/ 13) *.0018*(1000000/44.01)*df$stn1_Q
df$flux_13 <- ((df$V1-df$V2)/ 37.6) *.0018*(1000000/44.01)*df$stn2_Q
df$flux_14 <- ((df$V1-df$V4)/ 100) *.0018*(1000000/44.01)*df$stn2_Q
df$flux_23 <- ((df$V1-df$V4)/ 24) *.0018*(1000000/44.01)*df$stn2_Q
df$flux_24 <- ((df$V1-df$V4)/ 88) *.0018*(1000000/44.01)*df$stn3_Q
df$flux_34 <- ((df$V1-df$V4)/ 64) *.0018*(1000000/44.01)*df$stn3_Q
```

## Plot data

### Histogram of Flux Stations 1 -> 2
```{r}
ggplot(df, warning = FALSE, message=FALSE)+
  geom_histogram(aes(x = flux_12, fill = Inj),binwidth = 1)+
  geom_vline(xintercept = 0, linetype="dotted", color = "#4B9CD3", size=1.5)+
  xlim(-10,50)+
  ylim(0,2600)+
  labs(x = "Flux", y="Count of values",title = "Station 1 -> 2")
```

### Histogram of Flux Stations 1 -> 4
```{r}
ggplot(df)+
  geom_histogram(aes(x = flux_14),binwidth = 1)
```

## Flux and time
```{r fluxTime, echo=FALSE, warning=FALSE}
fluxTime12 <- ggplot(df)+
  geom_point(aes(x=DateTime, y= flux_12))

```

## Flux by day
```{r}
df$day <- as.factor(substr(as.character(df$DateTime),1,10))
times <- substr(as.character(df$DateTime),12,16)
df$time <- strftime(df$DateTime, format="%H:%M")
df$time <- as.POSIXct(df$time, format="%H:%M")

ggplot(df)+
  geom_line(aes(x = time, y = flux_13, group=day, col=day))
```


### ppt and Flux
```{r plot}
pptDaily <- read.csv(here("data_4_analysis/ppt.csv"))
pptDaily$DateTime <- as.POSIXct(pptDaily$DateTime)

pptBar <- ggplot()+
  geom_bar(data = pptDaily,stat = "identity", aes(x = DateTime, y = ppt_mm))+
  geom_point(data = df,aes(x = DateTime, y = flux_12))


pptBar
```

## Let's remove the injections




```{r}
nonInjection1 <- df%>%
  filter(DateTime > as.POSIXct("2019-07-12")&DateTime < as.POSIXct("2019-07-16 14:00"))

nonInjection2 <- df%>%
  filter(DateTime > as.POSIXct("2019-07-16 21:00")&DateTime < as.POSIXct("2019-07-22 14:00"))

nonInjection3 <- df%>%
  filter(DateTime > as.POSIXct("2019-07-22 21:00")&DateTime < as.POSIXct("2019-07-26 12:30"))

nonInjection4 <- df%>%
  filter(DateTime > as.POSIXct("2019-07-26 18:00")&DateTime < as.POSIXct("2019-08-01 15:30"))

nonInjection5 <- df%>%
  filter(DateTime > as.POSIXct("2019-08-01 21:00")&DateTime < as.POSIXct("2019-08-05 16:00"))

nonInjection6 <- df%>%
  filter(DateTime > as.POSIXct("2019-08-05 21:00")&DateTime < as.POSIXct("2019-08-08 12:30"))

nonInjection7 <- df%>%
  filter(DateTime > as.POSIXct("2019-08-08 16:00"))

nonInjections <- rbind(nonInjection1,nonInjection2,nonInjection3,nonInjection4,nonInjection5,nonInjection6,nonInjection7)

ggplot()+
  geom_bar(data = pptDaily,stat = "identity", aes(x = DateTime, y = ppt_mm))+
  geom_point(data = nonInjections,aes(x = DateTime, y = flux_12))+
  labs(x = "Date", y="ppt", title = "Flux: Station 1 -> 2")

ggplot()+
  geom_bar(data = pptDaily,stat = "identity", aes(x = DateTime, y = ppt_mm))+
  geom_point(data = nonInjections,aes(x = DateTime, y = flux_14))+
  labs(x = "Date", y="ppt", title = "Flux: Station 1 -> 4")
```

```{r}
ggplot(df)+
  geom_point(aes(x=flux_14, y = Flux_1, col=Flux_2))+
  labs(x = "Vaisala 1 -> Vaisala 4 flux", y = "EosFD 1 Flux")
```

