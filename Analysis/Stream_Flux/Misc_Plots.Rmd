---
title: "MiscPlots"
author: "Andrew"
date: "11/24/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
```

```{r data, echo=FALSE, message=FALSE}
df <- read.csv(here("data_4_analysis/All_Stream_Data.csv"))%>%
  select(DateTime,Inj,V1,V2,V3,V4,DO1_mg.L,DO2_mg.L,DO4_mg.L,Flux_1,Flux_2,tempC_436,airTemp_c,ppt24Tot,ppt48Tot,ppt72Tot,stn1_Q,stn2_Q,stn3_Q,stn4_Q)%>%
  filter(Inj == "No")
df$DateTime <- as.POSIXct(df$DateTime)

pptDaily <- read.csv(here("data_4_analysis/ppt.csv"))
pptDaily$DateTime <- as.POSIXct(pptDaily$DateTime)
```

# Create new time variables for ease of plotting
These new variables will help us plot each seperate day on a timescale of midnight -> midnight
```{r}
df$day <- as.factor(substr(as.character(df$DateTime),1,10))
times <- substr(as.character(df$DateTime),12,16)
df$time <- strftime(df$DateTime, format="%H:%M")
df$time <- as.POSIXct(df$time, format="%H:%M")
```

## Change in CO2
  The first step in calculating flux from the stream is to calculate change in CO2 concentrations between two points within the stream. We will look at two pairs of sensors (1->3 & 3->4). Once we determine change in CO2 concentration, we will convert ppm to uMols and then account for stream metabolism (respiration and photosynthesis) to calculate flux. First, let's visualize change in CO2 accross the pairs of sensors
```{r filt14PpmPlot, echo=FALSE, message=FALSE, warning=FALSE}
filt13 <- df%>%
  filter(!is.na(V1)&!is.na(V3))%>%
  filter(DateTime > as.POSIXct("2019-07-13 00:00:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 19:00:00")|DateTime > as.POSIXct("2019-08-14 23:59"))%>%
  filter(DateTime < as.POSIXct("2019-07-14 00:00")|DateTime > as.POSIXct("2019-07-14 23:59"))%>%
  filter(!DateTime == as.POSIXct("2019-08-09 09:57:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 11:15:00") | DateTime > as.POSIXct("2019-08-13 12:00:00"))

filt34 <- df%>%
  filter(!is.na(V1)&!is.na(V4))%>%
  filter(DateTime > as.POSIXct("2019-07-13 00:00:00"))%>%
  filter(DateTime < as.POSIXct("2019-08-13 19:00:00")|DateTime > as.POSIXct("2019-08-14 23:59"))%>%
  filter(DateTime < as.POSIXct("2019-07-14 00:00")|DateTime > as.POSIXct("2019-07-14 23:59"))%>%
  filter(!DateTime == as.POSIXct("2019-08-09 09:57:00"))
```


## DO vs CO2
```{r DOCO2}
filt13%>%
  plot_ly(x = ~V1, y = ~DO1_mg.L,hoverinfo = "text",
        text = ~paste("Time: ", DateTime,
        "<br> Discharge: ", round(stn1_Q,2), "liters per second"))%>%
  add_markers(color = ~tempC_436)%>%
  layout(
    title = "Station 1 Dissolved Oxygen vs CO2",
    xaxis = list(title = "CO2 (ppm)", type = "log"),
    yaxis = list(title = "Dissolved Oxygen (mg/L)")
  )
```

## DO vs Temperature
```{r DOvTemp, echo=FALSE}
filt%>%
plot_ly(x = ~tempC_436, y = ~DO1_mg.L,hoverinfo = "text",
        text = ~paste("Time: ", DateTime,
        "<br> CO2: ", V1))%>%
add_markers(color = ~V1)%>%
  layout(
    title = "Station 1 Dissolved Oxygen vs CO2",
    xaxis = list(title = "Water Temperature (C)"),
    yaxis = list(title = "Dissolved Oxygen (mg/L)")
  )
```

## DO at each sensor
```{r echo=FALSE}
dayPoly <- data.frame(x = c(as.POSIXct("06:15", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("06:15", format = "%H:%M")),y=c(3,3,8,8))

plotDO <- ggplot(filt13)+
  geom_polygon(data = dayPoly,aes(x=x,y=y),fill="#f2e198")+
  geom_vline(aes(xintercept = as.POSIXct("06:15", format = "%H:%M")))+
  geom_vline(aes(xintercept = as.POSIXct("18:21", format = "%H:%M")))+
  geom_point(aes(x = time, y = DO1_mg.L,group = day),col = "#4B9CD3",lwd=2)+
  geom_point(aes(x = time, y = DO4_mg.L,group = day),col ="#C7DA7D",lwd=2)+
  scale_color_gradient(name = "Discharge (L/s)", trans = "log",
                        breaks = my_breaks, labels = my_breaks)+
  labs(x = "Time",y="DO (mg/L)", title = "DO at Station 1 (Blue) and Station 4 (Green)")+
  theme_bw()
plotDO
```

## What's up with station 4 DO
There is a diel drop in DO in the late afternoon that seems to be related to temperature
```{r stn4DO, echo=FALSE}
dayPoly <- data.frame(x = c(as.POSIXct("06:15", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("18:21", format = "%H:%M"),as.POSIXct("06:15", format = "%H:%M")),y=c(6,6,8,8))

plotDO <- ggplot(filt)+
  geom_polygon(data = dayPoly,aes(x=x,y=y),fill="#f2e198")+
  geom_vline(aes(xintercept = as.POSIXct("06:15", format = "%H:%M")))+
  geom_vline(aes(xintercept = as.POSIXct("18:21", format = "%H:%M")))+
  geom_point(aes(x = time, y = DO4_mg.L,group = day, col = tempC_436),lwd=2)+
  labs(x = "Time",y="DO (mg/L)", title = "DO at Station 4")+
  theme_bw()
plotDO
```


## Dissolved Oxygen and Water Temperature
(Station 4)
```{r DOTemp, echo=FALSE}
filt%>%
  plot_ly(x =~tempC_436, y = ~DO4_mg.L)%>%
  add_markers()%>%
  layout(
    title = "Station 4 Dissolved Oxygen vs Water Temperature",
    xaxis = list(title = "Water Temperature (C)"),
    yaxis = list(title = "Dissolved Oxygen (mg/L)")
  )
```

### ppt and CO2 Change
```{r plot}
pptBar <- ggplot()+
  geom_bar(data = pptDaily,stat = "identity", aes(x = DateTime, y = ppt_mm))+
  geom_point(data = filt,aes(x = DateTime, y = evasion_14))


pptBar
```

## Evasion vs. Evasion
```{r}
ggplot(filt)+
  geom_point(shape=21,aes(x = evasion_14, y=Flux_1, fill = "eosFD 1"), fill="#4B9CD3", alpha =.6,size=2)+
  geom_point(shape=21,aes(x = evasion_14, y=Flux_2, fill = "eosFD 2"), fill="#C7DA7D", alpha = .6,size=2)+
  geom_smooth(aes(x=evasion_14,y=Flux_1),method='lm',formula=y~x, color = "#4B9CD3")+
  geom_smooth(aes(x=evasion_14,y=Flux_2),method='lm',formula=y~x,color ="#C7DA7D")+
  xlim(0,36)+
  ylim(0,6)
```