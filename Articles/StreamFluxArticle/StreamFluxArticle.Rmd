---
# Choose from this list of Journals:
# JGR: Atmospheres, JGR: Biogeosciences, JGR: Earth Surface, 
# JGR: Oceans, JGR: Planets, JGR: Solid Earth, JGR: Space Physics, 
# Global Biogeochemical Cycles, Geophysical Research Letters, 
# Paleoceanography and Paleoclimatology, Radio Science, Reviews of Geophysics, 
# Tectonics, Space Weather, Water Resources Research, Geochemistry, Geophysics, 
# Geosystems, Journal of Advances in Modeling Earth Systems (JAMES),
# Earth's Future, Earth and Space Science, Geohealth
journal: "Geophysical Research Letters"
# Use draft to submit a paper
classoption: "draft,linenumbers"
# A title should be specific, informative, and brief. Use
# abbreviations only if they are defined in the abstract. Titles that
# start with general keywords then specific terms are optimized in
# searches
title: "Spatiotemporal Assessments of Greenhouse Gas Concentration and Flux in Headwater Tropical Streams"
# First name or initial followed by last name
# Authors are individuals who have significantly contributed to the
# research and preparation of the article. Group authors are allowed, if
# each author in the group is separately identified in an appendix.
# Additional author notes should be indicated with
authors:
  - name: Andrew R. Murray
    affil: 1
  - name: Keridwen Whitmore
    affil: 1
  - name: Diego Riveros-Iregui
    affil: 1
  - name: Andrea Encalada
    affil: 2
  - name: Esteban Suarez
    affil: 2
  - name: Gonzalo Rivas-Torres
    affil: 2
affiliations:
  - number: 1
    name: "University of North Carolina - Chapel Hill Department of Geography"
  - number: 2
    name: "Universidad de San Francisco de Quito"
# More than one corresponding author is allowed in this LaTeX file and for
# publication; but only one corresponding author is allowed in our editorial system.
corresponding_author:
  - name: Andrew Murray
    email: armurray@live.unc.edu
keypoints:  
  - "Streams in the Páramo region are carbon sources."
  - "Variability in carbon evasion is driven by discharge and slope."
  - "CO~2~ evasion can be quantified with a minimal appraoch."
abstract: "Long thought to be a carbon sink, the Páramo region of the Andes may be a significant carbon source. We evaluated the spatiotemporal dynamics of CO~2~ concentration and flux in a high-elevation stream. We measured 15-min dissolved CO~2~, O~2~, and discharge, across a wetland-stream transition, characteristic of tropical, alpine environments. "
plain_language_summary: "Streams emit carbon dioxide to the atmosphere, but how much? Recent research suggests that steaper streams emit more carbon dioxide since they are more turbulent, but the amount of carbon dioxide a stream emits is also dependent on the carbon content of the local ecosystem. The paramo, which is a region in the high Andes mountains in Peru, Ecuador and Columbia, above the treeline (~ 10,000 ft) and below the snow line (~ 16,000 ft), is made up of extensive peatlands which hold enormous amounts of carbon. In the past, it was believed that the paramo took in carbon from the atmosphere and stored it however, recent research suggests that the region has reversed course and is now emitting more carbon into the atmosphere than it is taking in. A principal way that carbon is moved from the soils into the atmosphere is through the water cycle. We set up a sensor network in a stream in the Ecuadorian paramo to measure changes in carbon dioxide and dissolved oxygen, while also recording stream discharge. We then took this data and created a method for determining how much carbon dioxide is being emitted from the stream to the atmosphere and how that relates to discharge, steepness of the stream, and precipitation."
output: 
    rticles::agu_article
bibliography: references.bib
header-includes: 
      - \usepackage{soulutf8}  # For UTF8 chars in TrackChanges
# AGU recommends using the trackchanges LaTeX package in the edition process
# which is available from this link:
# https://publications.agu.org/files/2019/02/January-14-2019-latex-templates.zip
always_allow_html: true
---

```{r include=FALSE}
# Some recommended settings. 
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
library(lubridate)
library(here)
knitr::opts_chunk$set(
  echo = FALSE,
  fig.pos = 'h',
  out.extra = "",   # To force the use of figure enviroment
  fig.cap = "Please caption every figure"
)
webshot::install_phantomjs()
```

```{r keypoints_check, echo=FALSE, results='asis', eval = TRUE}
# This chunk adds a warning if any keypoint is longer than 100 characters. 
# To disable it, you can remove it or set eval to FALSE.
if (any(nchar(rmarkdown::metadata$keypoints) > 100)) {
  cat("\\textcolor{red}{\\textbf{Warning}: keypoint(s)", 
      knitr::combine_words(which(nchar(rmarkdown::metadata$keypoints) > 100)), 
      "longer than 100 characters.}")
}
```

```{r dataPrep, echo=FALSE, warning=FALSE, message=FALSE}
df <- read.csv(here::here("data_4_analysis/All_Stream_Data.csv"))%>%
  select(DateTime,Inj.x,V1,V2,V3,V4,DO1_mg.L,DO2_mg.L,DO4_mg.L,Flux_1,Flux_2,tempC_436,airTemp_c,ppt24Tot,ppt48Tot,ppt72Tot,stn1_Q,stn2_Q,stn3_Q,stn4_Q)%>%
  filter(Inj.x == "No")
df$DateTime <- ymd_hms(df$DateTime)
df <- df[1:nrow(df)-1,]

pptDaily <- read.csv(here::here("data_4_analysis/ppt.csv"))
pptDaily$DateTime <- ymd(pptDaily$DateTime)
df$day <- as.factor(substr(as.character(df$DateTime),1,10))
times <- substr(as.character(df$DateTime),12,16)
df$time <- strftime(df$DateTime, format="%H:%M")
df$time <- ymd_hm(paste0("2019-07-01-",df$time))
df$Q <- df$stn3_Q*1000

todayStart <- ymd_hms(paste0(Sys.Date(),"00:00:00"))
todayEnd <- ymd_hms(paste0(Sys.Date(),"23:59:59"))

# Axis font
xaxisFont <- list(
  family = "Arial, sans-serif",
  size = 12,
  color = "black"
)

yaxisFont <- list(
  family = "Arial, sans-serif",
  size = 12,
  color = "black"
)

labelFont <- list(
  family = "Arial, sans-serif",
  size = 14,
  color = "black"
)

df <- df%>%
  arrange(Q)%>%
  mutate(Discharge = ifelse( Q <5, "< 5",
                                   ifelse(Q > 4.99 & Q <10, "< 10",
                                          ifelse(Q > 9.99 & Q <15, "< 15",
                                                 ifelse(Q > 14.99 & Q < Inf, "< 65", NA)))))

filt13 <- df%>%
  filter(!is.na(V1)&!is.na(V3))%>%
  filter(DateTime > ymd_hms("2019-07-13 00:00:00"))%>%
  filter(DateTime < ymd_hms("2019-08-13 19:00:00")|DateTime > ymd_hms("2019-08-14 23:59"))%>%
  filter(DateTime < ymd_hms("2019-07-14 00:00:00")|DateTime > ymd_hms("2019-07-14 23:59:00"))%>%
  filter(!DateTime == ymd_hms("2019-08-09 09:57:00"))%>%
  filter(DateTime < ymd_hms("2019-08-13 11:15:00") | DateTime > ymd_hms("2019-08-13 12:00:00"))

filt34 <- df%>%
  filter(!is.na(V1)&!is.na(V4))%>%
  filter(DateTime > ymd_hms("2019-07-13 00:00:00"))%>%
  filter(DateTime < ymd_hms("2019-08-13 19:00:00")|DateTime > ymd_hms("2019-08-14 23:59"))%>%
  filter(DateTime < ymd_hms("2019-07-14 00:00:00")|DateTime > ymd_hms("2019-07-14 23:59:00"))%>%
  filter(!DateTime == ymd_hms("2019-08-09 09:57:00"))


```

# Introduction
It is well known that CO~2~ flux from freshwater streams impacts the global carbon cycle, however our ability to quantify these affects at a variety of spatial and temporal scales remains limited. The Páramo has historically been thought to be a carbon sink however, recent research suggests that it is now a source of carbon to the atmosphere \citep{carrillO2019breathing}. We tested two methods of quantifying CO~2~ evasion in headwater streams in the Páramo region of Ecuador and discuss the results and implications of our findings. We utilized eosense EosFD flux chamber sensors to measure CO~2~ flux directly from streams using in-stream flotation devices. Additionally, we used multiple Vaisala CO~2~ concentration sensors, fitted with waterproof PTFE sleeves to monitor change in in-stream concentration and calculated flux by converting concentration to mass per area time using the formula:

\begin{linenomath*}
\begin{equation}
f=\frac{\Delta ppm}{A}*.0018*\frac{10^6}{44.01}*Q+(R-P)
\end{equation}
\end{linenomath*}

Where $f$ equals flux in $µmol\:m^{-2}s^{-1}$, $\Delta ppm$ is the change in CO~2~ ppm between sensors, $R$ is stream respiration in ppm, $P$ is gross primary production in ppm, A is the stream surface area between sensors in $m^2$, .0018 is the conversion coefficient for $CO_2$ from ppm to $g\:m^{-3}$ and 44.01 is the molar mass of $CO_2$.

## Background
The Páramo region is characterized by high elevation, mountainous wetlands that are connected by turbulent streams. Connectivity can be seasonal and dependent upon precipitation intensity. Our specific site lies on the western edge of the Andean continental divide. The site receives mean monthly precipitation of 121 mm (Standard deviation = 61mm). Precipitation is moderately seasonal with maximum precipitation typically occurring in July and minimum precipitation in February. The site experiences some level of precipitation on 83.5% of days. Mean daily temperature is 50 C. We instrumented a reach approximately 140 meters in length which serves as a direct outlet to a wetland with an area of 2.3 Ha as well as multiple additional wetlands further upstream. Four sensor clusters were installed at various intervals representing various stream gradients (figure 1). A waterfall measuring ~4m exists between station 3 and 4.

# Methods
Four Vaisala GM-220 CO~2~ sensors were used to measure dissolved in-stream CO~2~ concentrations. We used waterproof PTFE sleeves, following the method presented in Johnson., et al.(2010). The Vaisala sensors, which have a range of 0-10,000 ppm, have a margin of error of 150 ppm (1.5%). To minimize error, all four sensors were initially collocated to establish offset values.
  Two eosFD (EoSense) chamber sensors were positioned in the stream using custom made floating platforms. One sensor was located between Station 1 and 2, and the other was collocated with station 4.
To estimate evasion from the reach, we quantified CO~2~ change between station 1 and 4.

```{r filt14PpmPlot, echo=FALSE, message=FALSE, warning=FALSE,fig.height=5,fig.width=6, fig.cap = "This is that real nice caption!"}

legendtitle <- list(yref='paper',xref="paper",y=1.9,x=1.35, text="Discharge<br> [L/s<sup>-1</sup>]",showarrow=F)

plotly13Ppm <- filt13%>%
  arrange(Q)%>%
  plot_ly(x = ~time, y = ~V3-V1)%>%
  add_markers(color = ~factor(Discharge, c('< 5', '< 10', '< 15', '< 65')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"), legendgroup = ~Discharge, showlegend = F,marker = list(size = 5))%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(ymd_hm("2019-07-01 00:00"))*1000,
             as.numeric(ymd_hm("2019-07-02 04:00"))*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
    showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "&#916; CO2 (Station 3-1 / Station 4-3)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = ymd_hm("2019-07-01 06:15"), x1 = ymd_hm("2019-07-01 18:21"), xref = "x",
                    y0 = -2500, y1 = 100, yref = "y",layer='below')),
  yaxis = list(title = "&#916;CO2 [ppm]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend=T)


plotly34Ppm <- filt34%>%
  arrange(stn3_Q)%>%
  plot_ly(x = ~time, y = ~V4-V3, sort = FALSE)%>%
  add_markers(color = ~factor(Discharge, levels = c('< 5', '< 10', '< 15', '< 65')), colors = c("#a1dab4","#41b6c4","#2c7fb8","#253494"),legendgroup = ~Discharge, marker = list(size = 5))%>%
  colorbar(title = "Discharge [L/s<sup>-1</sup>]")%>%
  layout(
    xaxis = list(
    range= c(as.numeric(ymd_hm("2019-07-01 00:00"))*1000,
             as.numeric(ymd_hm("2019-07-02 04:00"))*1000),
    type = "date",
    title = "Time", titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 325,
  tickfont = xaxisFont, tickformat = "%H:%M"),
    title = "&#916; CO2 (Station 3-1 / Station 4-3)",
         shapes = list(
               list(type = "rect",
                    fillcolor = "yellow", line = list(color = "yellow"), opacity = .2,
                    x0 = ymd_hm("2019-07-01 06:15"), x1 = ymd_hm("2019-07-01 18:21"), xref = "x",
                    y0 = -2500, y1 = 100, yref = "y",layer='below')),
  yaxis = list(title = "&Delta;CO2 [ppm]",titlefont = labelFont,
  showticklabels = TRUE,
  tickangle = 0,
  tickfont = yaxisFont),
  showlegend = T,
  annotations = legendtitle,
  legend = list(x = 1, y = .5))%>%
  hide_colorbar()


subplot(plotly13Ppm,plotly34Ppm,nrows=2, shareX = T, margin = c(-.2,0,0,0))
```

# Data

# Results

# Conclusions



\acknowledgments

Data, as well as all scripts for conducting this analysis are hosted on GitHub and can be obtained at: https://github.com/ARMurray/Ecuador/tree/master/Articles/StreamFluxArticle

This work was funded by the National Science Foundation under award 1847331: *The role of small wetland connectivity in controlling greenhouse gas emissions and downstream carbon fluxes from headwater tropical streams.*

The authors would like to thank:

La Universidad de San Francisco de Quito for their material and institutional support throughout this research.


